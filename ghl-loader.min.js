//https://cdn.jsdelivr.net/gh/core-gs/masterstyle-gs@main/ghl-loader.min.js

(function () {
  // ----- helpers -----
  function getCurrentScript() {
    // robust currentScript fallback
    return document.currentScript || (function () {
      var s = document.getElementsByTagName('script');
      return s[s.length - 1] || null;
    })();
  }
  function getLocationIdFromURL() {
    var m = location.href.match(/\/v2\/location\/([^\/\?#]+)/);
    return m ? m[1] : null;
  }
  function scopeClass(id) { return "loc-" + id; } // digit-safe
  function onReady(fn) {
    if (document.readyState !== "loading") fn();
    else document.addEventListener("DOMContentLoaded", fn);
  }
  function ensureStylesheetLink(href) {
    if (!href) return null;
    var exist = document.querySelector('link[rel="stylesheet"][href="' + href + '"]');
    if (exist) return exist;
    var l = document.createElement('link');
    l.rel = 'stylesheet';
    l.href = href;
    document.head.appendChild(l);
    return l;
  }
  function promotePreloadToStylesheet(node) {
    if (!node) return null;
    var href = node.getAttribute('href');
    if (!href) return null;
    // Create a dedicated stylesheet link (safer than toggling rel on preload)
    return ensureStylesheetLink(href);
  }
  function first(arrLike, pred) {
    for (var i = 0; i < arrLike.length; i++) {
      if (pred(arrLike[i])) return arrLike[i];
    }
    return null;
  }

  // ----- main -----
  var CS = getCurrentScript();
  var scopeMode = (CS && CS.getAttribute('data-scope')) || 'auto'; // "auto" | "blank"

  var TL = (window.__TL = window.__TL || {});
  TL.a = TL.a || false; // applied once
  TL.m = TL.m || false; // matched once

  function applyForId(id) {
    if (TL.a) return; // already applied

    // Add digit-safe scope class to <html> (optional but recommended)
    if (id && id !== 'blank') {
      document.documentElement.classList.add(scopeClass(id));
      TL.m = true;
    }

    // Find candidate links
    var allLinks = document.querySelectorAll('link[data-ghl-id], link[data-ghl-global]');
    // 1) exact id match
    var match = id && id !== 'blank'
      ? first(allLinks, function (n) { return n.getAttribute('data-ghl-id') === id; })
      : null;

    // 2) fallback to global/blank
    if (!match) {
      match = first(allLinks, function (n) {
        return n.hasAttribute('data-ghl-global') ||
               n.getAttribute('data-ghl-id') === 'blank';
      });
    }

    // Promote only the selected link to stylesheet
    if (match) {
      promotePreloadToStylesheet(match);
    }

    // (Optional) Remove non-selected preloads to save bytes (safe to skip)
    // for (var i = 0; i < allLinks.length; i++) {
    //   var n = allLinks[i];
    //   if (n !== match) {
    //     n.parentNode && n.parentNode.removeChild(n);
    //   }
    // }

    TL.a = true;
  }

  function start() {
    if (scopeMode === 'blank') {
      // Force global apply after short delay (for non-location pages)
      setTimeout(function(){ applyForId('blank'); }, 50);
      return;
    }

    // auto mode: wait for SPA route to reveal /v2/location/:id (max ~10s)
    var t0 = Date.now();
    var timer = setInterval(function () {
      var id = getLocationIdFromURL();
      if (id || Date.now() - t0 > 10000) {
        clearInterval(timer);
        applyForId(id || 'blank');
      }
    }, 120);
  }

  onReady(start);
})();

